bl_info = {
    "name": "Skirt Root Table Builder",
    "author": "DEEP CRIMSON",
    "version": (1, 0, 0),
    "blender": (3, 6, 0),
    "category": "Rigging",
}

import bpy
from bpy.types import (
    Panel, Operator, PropertyGroup, UIList
)
from bpy.props import (
    StringProperty,
    CollectionProperty,
    IntProperty
)

# -------------------------
# Data
# -------------------------

class SkirtRootItem(PropertyGroup):
    bone_name: StringProperty(name="Bone Name")


class SkirtTableCell(PropertyGroup):
    bone_name: StringProperty(name="Bone Name")
    row: IntProperty()
    col: IntProperty()
    
class SkirtRigidMapItem(PropertyGroup):
    bone_name: StringProperty()
    rigid_name: StringProperty()


# -------------------------
# Utilities
# -------------------------

def get_chain_linear(root_bone):
    """
    1本道のチェーンのみ取得する
    分岐があった場合は最初の子のみ使用
    """
    chain = [root_bone]
    current = root_bone

    while current.children:
        if len(current.children) > 1:
            print(f"[Skirt] Warning: {current.name} has multiple children")

        current = current.children[0]
        chain.append(current)

    return chain
def get_rigid_name_by_bone(scene, bone_name):
    for item in scene.skirt_rigid_map:
        if item.bone_name == bone_name:
            return item.rigid_name
    return None


def get_rigid_by_bone(scene, bone_name):
    for item in scene.skirt_rigid_map:
        if item.bone_name == bone_name:
            return item.rigid_name
    return None

def get_mmd_rigid_objects(context):
    rigids = []

    for obj in context.scene.objects:
        if hasattr(obj, "mmd_rigid"):
            # MMD剛体は type が定義されている
            if obj.mmd_rigid.type != 'NONE':
                rigids.append(obj)

    return rigids

def build_rigid_map(context):
    """
    bone_name -> [rigid_object, ...] の辞書を作る
    """
    rigid_map = {}

    for obj in get_mmd_rigid_objects(context):
        bone = obj.mmd_rigid.bone
        if not bone:
            continue

        rigid_map.setdefault(bone, []).append(obj)

    return rigid_map

# ------------------------
# Rigid helper functions
# ------------------------

def get_rigid_object_by_name(rigid_name):
    """rigid body object を名前から取得"""
    if not rigid_name:
        return None

    return bpy.data.objects.get(rigid_name)


# -------------------------
# Operators
# -------------------------

class SKIRT_OT_add_root_from_selection(Operator):
    bl_idname = "skirt.add_root_from_selection"
    bl_label = "Add Root From Selection"

    def execute(self, context):
        arm = context.object
        if not arm or arm.type != 'ARMATURE':
            return {'CANCELLED'}

        scene = context.scene
        scene.skirt_root_order.clear()

        for bone in context.selected_pose_bones:
            item = scene.skirt_root_order.add()
            item.bone_name = bone.name

        scene.skirt_root_index = 0
        return {'FINISHED'}


class SKIRT_OT_move_root(Operator):
    bl_idname = "skirt.move_root"
    bl_label = "Move Root"

    direction: StringProperty()

    def execute(self, context):
        scene = context.scene
        idx = scene.skirt_root_index
        lst = scene.skirt_root_order

        if self.direction == 'UP' and idx > 0:
            lst.move(idx, idx - 1)
            scene.skirt_root_index -= 1
        elif self.direction == 'DOWN' and idx < len(lst) - 1:
            lst.move(idx, idx + 1)
            scene.skirt_root_index += 1

        return {'FINISHED'}


class SKIRT_OT_build_table(Operator):
    bl_idname = "skirt.build_table"
    bl_label = "Build Table"

    def execute(self, context):
        scene = context.scene
        scene.skirt_table.clear()

        arm = context.object
        if not arm or arm.type != 'ARMATURE':
            return {'CANCELLED'}

        roots = [item.bone_name for item in scene.skirt_root_order]

        for col, root_name in enumerate(roots):
            root = arm.data.bones.get(root_name)
            if not root:
                continue

            chain = get_chain_linear(root)

            for row, bone in enumerate(chain):
                cell = scene.skirt_table.add()
                cell.bone_name = bone.name
                cell.row = row
                cell.col = col

        return {'FINISHED'}




class SKIRT_OT_select_table_cell(Operator):
    bl_idname = "skirt.select_table_cell"
    bl_label = "Select Bone From Table"

    bone_name: StringProperty()

    def execute(self, context):
        arm = context.object
        if not arm or arm.type != 'ARMATURE':
            return {'CANCELLED'}

        bpy.ops.object.mode_set(mode='POSE')

        for pb in arm.pose.bones:
            pb.bone.select = False

        pb = arm.pose.bones.get(self.bone_name)
        if pb:
            pb.bone.select = True
            arm.data.bones.active = pb.bone

        return {'FINISHED'}
    
class SKIRT_OT_select_cell(Operator):
    bl_idname = "skirt.select_cell"
    bl_label = "Select Cell"

    bone_name: StringProperty()

    def invoke(self, context, event):
        arm = context.object
        if not arm or arm.type != 'ARMATURE':
            return {'CANCELLED'}

        bpy.ops.object.mode_set(mode='POSE')

        pb = arm.pose.bones.get(self.bone_name)
        if not pb:
            return {'CANCELLED'}

        if not event.shift and not event.ctrl:
            for b in arm.pose.bones:
                b.bone.select = False

        if event.ctrl or event.alt:
            pb.bone.select = not pb.bone.select
        else:
            pb.bone.select = True

        arm.data.bones.active = pb.bone
        return {'FINISHED'}

class SKIRT_OT_select_row(Operator):
    bl_idname = "skirt.select_row"
    bl_label = "Select Row"

    row: IntProperty()

    def invoke(self, context, event):
        arm = context.object
        bpy.ops.object.mode_set(mode='POSE')

        bones = [
            c.bone_name for c in context.scene.skirt_table
            if c.row == self.row
        ]

        if not event.shift and not event.ctrl:
            for b in arm.pose.bones:
                b.bone.select = False

        for name in bones:
            pb = arm.pose.bones.get(name)
            if not pb:
                continue

            if event.alt or event.ctrl:
                pb.bone.select = not pb.bone.select
            else:
                pb.bone.select = True

        return {'FINISHED'}
class SKIRT_OT_select_col(Operator):
    bl_idname = "skirt.select_col"
    bl_label = "Select Column"

    col: IntProperty()

    def invoke(self, context, event):
        arm = context.object
        bpy.ops.object.mode_set(mode='POSE')

        bones = [
            c.bone_name for c in context.scene.skirt_table
            if c.col == self.col
        ]

        if not event.shift and not event.ctrl:
            for b in arm.pose.bones:
                b.bone.select = False

        for name in bones:
            pb = arm.pose.bones.get(name)
            if not pb:
                continue

            if event.alt or event.ctrl:
                pb.bone.select = not pb.bone.select
            else:
                pb.bone.select = True

        return {'FINISHED'}


class SKIRT_OT_select_rigid_cell(Operator):
    bl_idname = "skirt.select_rigid_cell"
    bl_label = "Select Rigid Body"

    bone_name: StringProperty()

    def invoke(self, context, event):
        scene = context.scene
        
        # 修正点: .get() の代わりにヘルパー関数を使用する
        rigid_name = get_rigid_name_by_bone(scene, self.bone_name)
        
        # rigid_name が None でないことを確認してからオブジェクトを取得
        if rigid_name:
            rigid_obj = bpy.data.objects.get(rigid_name)

            if rigid_obj:
                # 選択状態のクリア
                if not event.shift and not event.ctrl:
                    bpy.ops.object.select_all(action='DESELECT')
                
                # オブジェクトを選択し、アクティブにする
                context.view_layer.objects.active = rigid_obj
                rigid_obj.select_set(True)

        return {'FINISHED'}

    
class SKIRT_OT_select_rigid_row(Operator):
    bl_idname = "skirt.select_rigid_row"
    bl_label = "Select Rigid Row"

    row: IntProperty()

    def invoke(self, context, event):
        scene = context.scene
        table = scene.skirt_table

        # オブジェクト名のリストを作成
        target_names = []
        for cell in table:
            if cell.row == self.row:
                # bone_name から rigid_name を取得
                rigid_name = get_rigid_name_by_bone(scene, cell.bone_name)
                if rigid_name:
                    target_names.append(rigid_name)

        # Shift/Ctrlキーが押されていない場合は、まず全ての選択を解除
        if not event.shift and not event.ctrl:
            bpy.ops.object.select_all(action='DESELECT')

        # 名前リストからオブジェクトを取得して選択状態を変更
        for name in target_names:
            obj = bpy.data.objects.get(name)
            if obj:
                if event.ctrl or event.alt:
                    obj.select_set(not obj.select_get())
                else:
                    obj.select_set(True)

        return {'FINISHED'}
    
class SKIRT_OT_select_rigid_col(Operator):
    bl_idname = "skirt.select_rigid_col"
    bl_label = "Select Rigid Column"

    col: IntProperty()

    def invoke(self, context, event):
        scene = context.scene
        table = scene.skirt_table

        target_names = []
        for cell in table:
            if cell.col == self.col:
                rigid_name = get_rigid_name_by_bone(scene, cell.bone_name)
                if rigid_name:
                    target_names.append(rigid_name)

        if not event.shift and not event.ctrl:
            bpy.ops.object.select_all(action='DESELECT')

        for name in target_names:
            obj = bpy.data.objects.get(name)
            if obj:
                if event.ctrl or event.alt:
                    obj.select_set(not obj.select_get())
                else:
                    obj.select_set(True)

        return {'FINISHED'}

class SKIRT_OT_scan_rigids(Operator):
    bl_idname = "skirt.scan_rigids"
    bl_label = "Scan Rigids"
    bl_description = "MMD剛体を検索してボーン対応表を作成"

    def execute(self, context):
        scene = context.scene

        # UI用キャッシュをクリア
        scene.skirt_rigid_map.clear()

        # rigid_map を構築
        rigid_map = build_rigid_map(context)

        count = 0

        for bone_name, rigids in rigid_map.items():
            for rigid in rigids:
                item = scene.skirt_rigid_map.add()
                item.bone_name = bone_name
                item.rigid_name = rigid.name
                count += 1

        self.report({'INFO'}, f"{count} 個の剛体を取得しました")
        return {'FINISHED'}



# -------------------------
# UI
# -------------------------

class SKIRT_UL_root_list(UIList):
    def draw_item(self, context, layout, data, item, icon, active_data, active_propname):
        layout.label(text=item.bone_name)


class SKIRT_PT_main(Panel):
    bl_label = "Skirt Bone Table"
    bl_idname = "SKIRT_PT_main"
    bl_space_type = 'VIEW_3D'
    bl_region_type = 'UI'
    bl_category = 'Skirt'

    def draw(self, context):
        layout = self.layout
        scene = context.scene

        layout.operator("skirt.add_root_from_selection")

        row = layout.row()
        row.template_list(
            "SKIRT_UL_root_list",
            "",
            scene,
            "skirt_root_order",
            scene,
            "skirt_root_index"
        )

        col = row.column(align=True)
        col.operator("skirt.move_root", text="▲").direction = 'UP'
        col.operator("skirt.move_root", text="▼").direction = 'DOWN'

        layout.separator()
        layout.operator("skirt.build_table")

        if not scene.skirt_table:
            return

        layout.separator()

        layout.separator()
        layout.label(text="Skirt Bone Table")

        table = scene.skirt_table
        if not table:
            layout.label(text="No Table Data")
            return

        max_row = max(c.row for c in table) + 1
        max_col = max(c.col for c in table) + 1

        # row / col -> cell 辞書化（高速＆安定）
        cell_map = {(c.row, c.col): c for c in table}

        box = layout.box()

        # -----------------
        # 列ヘッダー
        # -----------------
        header = box.row(align=True)
        header.label(text="")  # 左上空白

        for c in range(max_col):
            op = header.operator(
                "skirt.select_col",
                text=f"Col {c}",
                emboss=True
            )
            op.col = c

        # -----------------
        # 行 + セル
        # -----------------
        for r in range(max_row):
            row_ui = box.row(align=True)

            # 行ヘッダー
            op = row_ui.operator(
                "skirt.select_row",
                text=f"{r:03}",
                emboss=True
            )
            op.row = r

            # セル
            for c in range(max_col):
                cell = cell_map.get((r, c))

                if cell:
                    op = row_ui.operator(
                        "skirt.select_cell",
                        text=cell.bone_name,
                        emboss=True
                    )
                    op.bone_name = cell.bone_name
                else:
                    row_ui.label(text="")
                    layout.separator()
        # =============================
        # Rigid Body Table
        # =============================
        layout.separator()
        layout.operator("skirt.scan_rigids", icon="VIEWZOOM")

        layout.separator()
        layout.label(text="Skirt Rigid Body Table")

        box = layout.box()

        # 列ヘッダー
        header = box.row(align=True)
        header.label(text="")

        for c in range(max_col):
            op = header.operator(
                "skirt.select_rigid_col",
                text=f"Col {c}",
                emboss=True
            )
            op.col = c

        # 行 + セル
        for r in range(max_row):
            row_ui = box.row(align=True)

            op = row_ui.operator(
                "skirt.select_rigid_row",
                text=f"{r:03}",
                emboss=True
            )
            op.row = r

            for c in range(max_col):
                cell = cell_map.get((r, c))
                if not cell:
                    row_ui.label(text="")
                    continue

                rigid_name = get_rigid_name_by_bone(context.scene, cell.bone_name)

                if rigid_name:
                    op = row_ui.operator(
                        "skirt.select_rigid_cell",
                        text=rigid_name,
                        emboss=True
                    )
                    op.bone_name = cell.bone_name
                else:
                    row_ui.label(text="-")





# -------------------------
# Register
# -------------------------

classes = (
    SkirtRootItem,
    SkirtTableCell,
    SkirtRigidMapItem,

    SKIRT_OT_add_root_from_selection,
    SKIRT_OT_move_root,
    SKIRT_OT_build_table,
    SKIRT_OT_scan_rigids,

    # ボーン選択
    SKIRT_OT_select_cell,
    SKIRT_OT_select_row,
    SKIRT_OT_select_col,

    # ★ 剛体選択（これを忘れている）
    SKIRT_OT_select_rigid_cell,
    SKIRT_OT_select_rigid_row,
    SKIRT_OT_select_rigid_col,

    SKIRT_UL_root_list,
    SKIRT_PT_main,
)




def register():
    for cls in classes:
        bpy.utils.register_class(cls)

    bpy.types.Scene.skirt_root_order = CollectionProperty(type=SkirtRootItem)
    bpy.types.Scene.skirt_root_index = IntProperty()
    bpy.types.Scene.skirt_table = CollectionProperty(type=SkirtTableCell)
    bpy.types.Scene.skirt_rigid_map = CollectionProperty(
    type=SkirtRigidMapItem
)



def unregister():
    for cls in reversed(classes):
        bpy.utils.unregister_class(cls)

    del bpy.types.Scene.skirt_root_order
    del bpy.types.Scene.skirt_root_index
    del bpy.types.Scene.skirt_table
    del bpy.types.Scene.skirt_rigid_map



if __name__ == "__main__":
    register()
